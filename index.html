<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Solar</title>
		<link rel="stylesheet" href="style.css">
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link rel="icon" href="img/icon.png">
	</head>
	<link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">
	<body>

			<script src="js/libraries/three.js"></script>
			<script src="js/libraries/PointerLockControls.js"></script>
			<script src="js/libraries/dat.gui.js"></script>
			<script src="js/libraries/jquery.min.js"></script>
			<script src="js/libraries/TweenMax.min.js"></script>
			<script src="js/controls.js"></script>
			<script src="js/makePlanets.js"></script>
			<script src="js/planet.js"></script>
			<script src="js/moon.js"></script>
			<script src="js/star.js"></script>
			<script src="js/satellite.js"> </script>
			<script src="js/gui/gui.js"></script>
			<script src="js/gui/add.js"></script>
			<script src="js/gui/remove.js"></script>
			<script src="js/animation.js"></script>
			<script src="js/OBJLoader.js"></script>
			<script src="js/MTLLoader.js"></script>

		<div id="blocker">
			<img id = "border" src="img/border.png">
			<div id="startMessage">
				<p id="first">Welcome to <span id="bold">Solar</span></p>
				<p id="second">Click to Start <br /> <br />
					<span id="instructions">
							W, A, S, D = Move <br />
							SPACE, SHIFT = Up and Down <br />
							MOUSE = Look Around <br />
							ESC = Disable Controls
					</span>
				</p>
			</div>
			<div id="info">
				<p id="name"></p>
				<p id="category"></p>
				<p id="desc"></p>
			</div>
		</div>

		<script>

			var camera, scene, renderer, controls, controlsEnabled;

			var moveForward = false;
			var moveBackward = false;
			var moveLeft = false;
			var moveRight = false;
			var moveUp = false;
			var moveDown = false;

			var prevTime = performance.now();
			var velocity = new THREE.Vector3();
			var direction = new THREE.Vector3();
			var color = new THREE.Color();
			var time = 0


			function init() {

				var ratio = window.innerWidth/window.innerHeight;
				camera = new THREE.PerspectiveCamera(45,ratio,1,100000);

				scene = new THREE.Scene();

				controls = new THREE.PointerLockControls( camera );

        		controls.enabled = false;
				controlsEnabled = false;
				scene.add( controls.getObject() );

				info = document.getElementById('info');
				d_name = document.getElementById('name');
				d_category = document.getElementById('category');
				d_desc = document.getElementById('desc');

				showStartUp();

				activateControls();

				var skybox_geometry = new THREE.BoxGeometry(10000, 10000, 10000);
				var skybox_image =
				[
					new THREE.MeshBasicMaterial( {map: new THREE.TextureLoader().load( "img/skybox/skybox_front.png"), side: THREE.DoubleSide}),
					new THREE.MeshBasicMaterial( {map: new THREE.TextureLoader().load( "img/skybox/skybox_back.png"), side: THREE.DoubleSide}),
					new THREE.MeshBasicMaterial( {map: new THREE.TextureLoader().load( "img/skybox/skybox_up.png"), side: THREE.DoubleSide}),
					new THREE.MeshBasicMaterial( {map: new THREE.TextureLoader().load( "img/skybox/skybox_down.png"), side: THREE.DoubleSide}),
					new THREE.MeshBasicMaterial( {map: new THREE.TextureLoader().load( "img/skybox/skybox_right.png"), side: THREE.DoubleSide}),
					new THREE.MeshBasicMaterial( {map: new THREE.TextureLoader().load( "img/skybox/skybox_left.png"), side: THREE.DoubleSide})
				];

				var skybox_material = new THREE.MeshFaceMaterial(skybox_image);
				var skybox = new THREE.Mesh ( skybox_geometry, skybox_material);
				scene.add(skybox);

				var mtlLoader = new THREE.MTLLoader();
				mtlLoader.setTexturePath( "models/deathstar_models/" );
				mtlLoader.setPath( "models/deathstar_models/" );

				mtlLoader.load("deathstar.obj.mtl", function(deathstar_material)
				{
					deathstar_material.preload();
					var objLoader = new THREE.OBJLoader();
					objLoader.setPath( "models/deathstar_models/" );
					objLoader.setMaterials(deathstar_material);

					objLoader.load("deathstar.obj", function(mesh)
					{
						 var centerBounding;
						 var sizeBounding;
						 mesh.traverse(function(child)
						 {
								 if (child instanceof THREE.Mesh)
								 {
										 var deathstar_geometry = new THREE.Geometry().fromBufferGeometry(child.geometry);
										 deathstar_geometry.computeBoundingBox();
										 child.material.color= new THREE.Color(0.7,0.7,0.7);
										 centerBounding = deathstar_geometry.boundingBox.getCenter();
										 sizeBounding = deathstar_geometry.boundingBox.getSize();
								 }
						 });
						 scene.add(mesh);
						 var sca = new THREE.Matrix4();
						 var tra = new THREE.Matrix4();
						 var rot = new THREE.Matrix4();
						 var combined = new THREE.Matrix4();

						 sca.makeScale(8/sizeBounding.length(),8/sizeBounding.length(),8/sizeBounding.length());
						 //tra.makeTranslation (-CenterBB.x,-CenterBB.y,-CenterBB.z);
						 rot.makeRotationX(Math.PI / 2);

						 tra.makeTranslation (-centerBounding.x,-centerBounding.y*150,-centerBounding.z);
						 combined.multiply(sca);
						 combined.multiply(tra);
						 combined.multiply(rot);

						 mesh.applyMatrix(combined);
				 });
				});

				generatePlanets();

				buildGui();

				renderer = new THREE.WebGLRenderer( { antialias: true } );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.shadowMapEnabled = true;
				renderer.shadowMapHard = true;

				document.body.appendChild( renderer.domElement );

				var ambientlight = new THREE.AmbientLight(new THREE.Color(1, 1, 1), 0.5);
				scene.add(ambientlight);

				controls.getObject().translateZ(100);

				window.addEventListener( 'resize', onWindowResize, false );
			}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
			}

			init();
			animate();

			function animate() {

				requestAnimationFrame( animate );

				if ( controlsEnabled == true ) {

				 var time = performance.now();
					var delta =  ( time - prevTime ) / 1000;

					velocity.x -= velocity.x * 10.0 * delta;
					velocity.z -= velocity.z * 10.0 * delta;
					velocity.y -= velocity.y * 10.0 * delta;

					direction.z = Number( moveForward ) - Number( moveBackward );
					direction.x = Number( moveLeft ) - Number( moveRight );
					direction.y = Number( moveDown ) - Number( moveUp );
					direction.normalize();

					if ( moveForward || moveBackward )
						velocity.z -= direction.z * 400.0 * delta;

					if ( moveLeft || moveRight )
						velocity.x -= direction.x * 400.0 * delta;

					if ( moveUp || moveDown )
						velocity.y -= direction.y * 400.0 * delta;

					controls.getObject().translateX( velocity.x * delta );
					controls.getObject().translateZ( velocity.z * delta );
					controls.getObject().translateY( velocity.y * delta );

					prevTime = time;

				}

				time = Date.now() * 0.0001;

				planets.forEach(function(planet) {
					var orbit = planet.userData.orbit;
					var speed = planet.userData.speed;
					planet.position.x = Math.cos(time * speed) * orbit;
					planet.position.z = Math.sin(time * speed) * orbit;


					planet.rotation.y += planet.userData.rotation;
				});

				moons.forEach(function(moon) {
					var orbit = moon.userData.orbit;
					var speed = moon.userData.speed;
					var centreName = moon.userData.centreMass;
					planets.forEach(function(planet) {
						if (planet.userData.name == centreName) {
							moon.position.x = planet.position.x;
							moon.position.z = planet.position.z;
						}
					});
					moon.position.x = Math.cos(time * speed) * orbit;
					moon.position.z = Math.sin(time * speed) * orbit;
				});

				//Satellite animation
				satellites.forEach(function(satellite) {
					var orbit = satellite.userData.orbit;
					var speed = satellite.userData.speed;
					var centreName = satellite.userData.centreMass;
					planets.forEach(function(planet) {
						if (planet.userData.name == centreName) {
							satellite.position.x = planet.position.x;
							satellite.position.z = planet.position.z;
						}
					});
					satellite.position.x = Math.cos(time * speed) * orbit;
					satellite.position.z = Math.sin(time * speed) * orbit;
					satellite.position.y = Math.cos(time * speed) * orbit;

				});

				renderer.render( scene, camera );

			}

		</script>
	</body>
</html>
